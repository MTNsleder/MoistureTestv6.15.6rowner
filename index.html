<!doctype html><html lang=en><head>
<meta charset=utf-8><title>MoisterTest Owner</title>
<meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel=manifest href=manifest.json><link rel=apple-touch-icon href=apple-touch-icon.png>
<meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black-translucent>
<meta name=theme-color content=#8b0a0a>
<style>
:root{--red:#c03232;--pad:14px}*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f7f3f3;color:#111}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e5e5;padding:calc(8px + env(safe-area-inset-top)) var(--pad) 8px;z-index:10;display:flex;align-items:center;gap:12px;justify-content:center}
header h1{margin:0;font-size:18px}
header .back{position:absolute;left:12px;top:calc(4px + env(safe-area-inset-top));padding:8px 10px;border-radius:10px;border:1px solid #e4caca;background:#fff;color:#7d1a1a}
main{max-width:1120px;margin:0 auto;padding:12px var(--pad) 140px}
fieldset{border:1px solid #e2c7c7;border-radius:12px;background:#fff;margin:12px 0;padding:10px}legend{font-weight:600;padding:0 8px;color:#7d1a1a}
label{display:block;font-size:14px;margin:8px 0 6px}input,select,button{font-size:16px}
input,select{width:100%;padding:10px;border:1px solid #d9b2b2;border-radius:10px;background:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.btn{display:block;width:100%;padding:12px;margin:6px 0 0;border:0;border-radius:12px;color:#fff;background:var(--red);cursor:pointer}
.btn.gray{background:#888}.small{font-size:12px;color:#666}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.card{background:#fff;border:1px solid #ecd4d4;border-radius:12px;padding:12px}
.action{color:#0b3c8a;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.bin-card{border:1px solid #e9d0d0;border-radius:12px;padding:12px;background:#fff}
.bin-title{font-weight:600;margin-bottom:6px}
.bin-meta{font-size:14px;line-height:1.3;color:#333}
.bin-actions{margin-top:8px;display:flex;gap:8px}
.btn.sm{padding:8px;border-radius:10px;font-size:14px}
</style></head>
<body>
  <header><button id=backBtn class=back disabled>&larr; Undo</button><h1>MoisterTest Owner</h1></header>
  <main>
    
<fieldset><legend>Meter & Crop</legend>
<div class=row3>
  <div><label>Meter</label><select id=meter><option value=919 selected>919 (3.5")</option><option value=minigac>Mini‑GAC</option></select></div>
  <div><label>Crop</label><select id=crop><option value=oats selected>Oats</option><option value=wheat>Wheat</option><option value=barley>Barley</option><option value=canola>Canola</option></select></div>
  <div><label>Sample size (grams)</label><input id=grams type=number step=1 placeholder="auto-fills"></div>
</div>
<div id=gramsNote class=small></div>
<div id=gramsWarn class="small" style="color:#8a6a00"></div>
</fieldset>

    
<fieldset><legend>Inputs</legend>
<div class=row3>
  <div><label>Meter reading</label><input id=reading type=number step=0.1 inputmode=decimal></div>
  <div><label>Grain temperature</label><div class=row>
    <select id=tempUnit><option value=C selected>°C</option><option value=F>°F</option></select>
    <input id=tempVal type=number step=0.1 inputmode=decimal>
  </div></div>
  <div><label>&nbsp;</label><button class=btn id=go>Calculate</button></div>
</div>
<div class=card id=result>Enter values and tap Calculate.</div>
</fieldset>

    
<fieldset><legend>Targets</legend>
<div class=row>
  <div><label>Target moisture for <b id=targetCropLabel>Oats</b> (%)</label>
    <div class=row><input id=targetVal type=number step=0.1 inputmode=decimal><button class=btn id=saveTarget>Save</button></div>
    <div class=small id=targetSaved></div>
  </div>
  <div>
    <label>Quick reference</label>
    <div id=targetsTable class=card style="max-height:220px;overflow:auto"></div>
  </div>
</div>
</fieldset>

    
<fieldset><legend>Bins/Bags</legend>
<div class=row>
  <div class=card>
    <div class=row>
      <select id=wbSelect></select>
      <button class="btn" id=wbAddBin>+ Add bin</button>
      <button class="btn gray" id=wbRename>Rename</button>
      <button class="btn gray" id=wbDelete>Delete</button>
      <button class="btn gray" id=wbClear>Clear</button>
    </div>
    <div class=row3 style="margin-top:8px">
      <div><label>Entry mode</label><select id=entryMode><option value=truck selected>Truck fractions</option><option value=bushels>Bushels</option></select></div>
      <div id=fractionBox><label>Truck fraction</label><select id=truckFrac><option value="1">1</option><option value="0.75">3/4</option><option value="0.5">1/2</option><option value="0.33">1/3</option><option value="0.25">1/4</option></select></div>
      <div id=bushelsBox style="display:none"><label>Bushels</label><input id=wbBushels type=number step=1></div>
    </div>
    <div class=row3 style="margin-top:8px">
      <div><label>Truck capacity by crop</label><select id=truckCrop><option value=oats selected>Oats</option><option value=wheat>Wheat</option><option value=barley>Barley</option><option value=canola>Canola</option></select></div>
      <div><label>Capacity (bu)</label><input id=truckCap type=number step=1></div>
      <div><label>&nbsp;</label><button class="btn gray" id=saveTruckCap>Save</button></div>
    </div>
    <div class=row style="margin-top:8px">
      <button class=btn id=wbAddSample>Add sample to bin</button>
      <button class="btn gray" id=wbManualAdd>Add manual log</button>
    </div>
    <div id=buPreview class=small style="color:#0b3c8a"></div>
  </div>
  <div class=card>
    <div><b>Active bin:</b> <span id=wbName>—</span></div>
    <div class=small style="margin-top:6px">Weighted avg: <b class=mono id=wbAvg>—</b>% • Total bu: <span class=mono id=wbTotal>0</span></div>
    <div id=wbTable style="margin-top:8px;max-height:260px;overflow:auto"></div>
  </div>
</div>
<div class=small id=binSyncMsg></div>
</fieldset>

    
<fieldset><legend>Team Sync</legend>
<div class=row3>
  <div><label>Enable</label><select id=syncEnable><option value=off>Off</option><option value=on selected>On</option></select></div>
  <div><label>Farm ID</label><input id=farmId value="Rogers Sask"></div>
  <div><label>Device name</label><input id=deviceName placeholder="Owner iPhone"></div>
</div>
<div class=row3>
  <div><label>Endpoint URL</label><input id=endpoint value="https://script.google.com/macros/s/AKfycbxLMIUamQ6cITBx7kfwGw0z_Bs4CKH96_Y9_0GkpqyAAIWQxlhgS4NU2RFivxg77Ip9ig/exec"></div>
  <div><label>Shared secret</label><input id=secret placeholder=""></div>
  <div><label>Auto‑push</label><select id=autoPush><option value=off>Off</option><option value=on selected>On</option></select></div>
</div>
<div class=row><button class=btn id=pushNow>Push last sample</button><button class=btn id=pullNow>Pull dashboard</button></div>
<div id=syncStatus class=small style="margin-top:6px;color:#0b3c8a"></div>
<div id=teamDash class=card style="margin-top:8px"></div>
</fieldset>

  </main>
  
<script>
function jget(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(e){ return d } }
function jset(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function toast(msg){ if(!document.getElementById('to')){ var t=document.createElement('div'); t.id='to'; t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='#000a'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; document.body.appendChild(t);} var el=document.getElementById('to'); el.textContent=msg; el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',1800); }

// ---- grams defaults & warning
var gramsDefault={oats:200,wheat:250,barley:225,canola:250};
function key(){ return (meter.value||'919')+'::'+(crop.value||'oats') }
function gramsStore(){ return jget('grams',{}) }
function gramsSave(o){ jset('grams',o) }
function applyGramsDefault(){
  var saved=gramsStore()[key()]; var def=gramsDefault[crop.value];
  grams.value=(saved!==undefined && saved!=='')?saved:(def||'');
  document.getElementById('gramsNote').textContent = def ? ('Factory sample for '+crop.value+': '+def+' g') : '';
  var warn = document.getElementById('gramsWarn');
  if(def && grams.value && Number(grams.value) !== def){
    warn.textContent = 'Warning: using '+grams.value+' g (factory '+def+' g). Meter reading may not compare directly.';
  } else { warn.textContent=''; }
}
if(grams){ grams.addEventListener('input', ()=>{ var g=gramsStore(); g[key()]=grams.value; gramsSave(g); applyGramsDefault(); }); }
if(meter){ meter.addEventListener('change', applyGramsDefault); }
if(crop){ crop.addEventListener('change', applyGramsDefault); }

// ---- quick calc (same as earlier minimal)
var presets={oats:[25,16.6,0.20,-0.10], wheat:[24,15.5,0.18,-0.07], barley:[24.5,15.8,0.19,-0.08], canola:[28,8.5,0.15,-0.06]};
var targetsDefault={oats:13.5,wheat:14.5,barley:14.5,canola:10.0};
function r1(x){ return Number(x).toFixed(1) }
function calcMoist(mr,tC,c){ var p=presets[c]; var M20=p[1]+(mr-p[0])*p[2]; return {M20:M20,noOff:(M20+(tC-20)*p[3])}; }
if(document.getElementById('go')){ go.onclick=function(){ var mr=parseFloat(reading.value), t=parseFloat(tempVal.value); if(isNaN(mr)||isNaN(t)){ result.textContent='Enter both values.'; return; } var tC=(tempUnit.value==='F')?((t-32)*5/9):t; var base=calcMoist(mr,tC,crop.value); var corrected=base.noOff; var tgt=(jget('targets',{})[crop.value]??targetsDefault[crop.value]); var diff=corrected - tgt; var msg='Target '+r1(tgt)+'%'; if(Math.abs(diff)>=0.2) msg += (diff>0?(' • OVER by '+r1(diff)+'%'):(' • UNDER by '+r1(-diff)+'%')); result.innerHTML='<div><b>'+r1(corrected)+'%</b> corrected moisture</div><div class=small>Base@20 °C '+r1(base.M20)+'%</div><div class=small style=margin-top:6px>'+msg+'</div>'; window._lastCalc={corrected:corrected}; }; }

// ---- bins local store
function wbStore(){ return jget('wetBins',{}) }
function wbSave(s){ jset('wetBins',s) }
function ensureDefaultBin(){ var s=wbStore(); if(!Object.keys(s).length){ s['Wet Bin 1']={samples:[]}; wbSave(s);}}
function wbActive(){ return wbStore()[wbSelect.value]||{samples:[]} }
function wbSetActive(d){ var s=wbStore(); s[wbSelect.value]=d; wbSave(s); }

// render & ops
function wbRender(){
  var b=wbActive(), sum=0,total=0;
  (b.samples||[]).forEach(r=>{ sum+=Number(r.moisture||0)*Number(r.bu||0); total+=Number(r.bu||0) });
  wbAvg.textContent = total? (sum/total).toFixed(1) : '—';
  wbTotal.textContent = total||0;
  if(!b.samples?.length){ wbTable.innerHTML='<div class=small>No samples.</div>'; return; }
  var rows='<table><thead><tr><th>time</th><th>crop</th><th>%</th><th>bu</th><th>act</th></tr></thead><tbody>';
  b.samples.slice().reverse().forEach(r=>{
    rows += '<tr><td>'+r.ts.slice(5,16).replace('T',' ')+'</td><td>'+(r.crop||'')+'</td><td>'+Number(r.moisture).toFixed(1)+'</td><td>'+Number(r.bu).toFixed(0)+'</td><td><span class=action data-id='+r.id+'>delete</span></td></tr>';
  });
  rows+='</tbody></table>'; wbTable.innerHTML=rows;
  Array.from(wbTable.querySelectorAll('.action')).forEach(a=>a.onclick=()=>delEntry(a.getAttribute('data-id')));
}

function currentBushels(){
  if(entryMode.value==='bushels') return parseFloat(wbBushels.value)||0;
  var capMap=jget('truckCaps',{}); var cap = capMap[truckCrop.value] ?? ({oats:2650,canola:1800,barley:1700,wheat:1500}[truckCrop.value]||2000);
  var frac=parseFloat(truckFrac.value)||0; return Math.round(frac*cap);
}
function updateBuPreview(){
  var bu=currentBushels();
  buPreview.textContent = bu?('This will add ~'+bu.toFixed(0)+' bu.') : '';
}
if(entryMode){ entryMode.onchange=()=>{ fractionBox.style.display=(entryMode.value==='truck')?'block':'none'; bushelsBox.style.display=(entryMode.value==='bushels')?'block':'none'; updateBuPreview(); }; }
if(truckFrac) truckFrac.addEventListener('change',updateBuPreview);
if(wbBushels) wbBushels.addEventListener('input',updateBuPreview);

// destructive actions + undo stack
var undo = jget('undo',null);
function pushUndo(action, payload){
  undo = {action:action, payload:payload, ts:Date.now()};
  jset('undo', undo);
  document.getElementById('backBtn').disabled=false;
}
function doUndo(){
  if(!undo){ toast('Nothing to undo'); return; }
  var u=undo; undo=null; jset('undo',null); document.getElementById('backBtn').disabled=true;
  if(u.action==='localReplaceBin'){
    var all=wbStore(); all[u.payload.name]={samples:u.payload.samples}; wbSave(all);
    if(wbSelect.value!==u.payload.name){ wbSelect.value=u.payload.name; }
    wbRender(); toast('Undo complete');
    // also push to server (setBinSamples)
    if(syncOn()){ push({action:'setBinSamples', farmId:cfg().farmId, secret:cfg().secret, bin:u.payload.name, samples:u.payload.samples}); }
  } else if(u.action==='localDeleteEntry'){
    var all=wbStore(); var b=all[wbSelect.value]; if(!b) b={samples:[]};
    b.samples.push(u.payload.entry); all[wbSelect.value]=b; wbSave(all); wbRender(); toast('Entry restored');
  } else if(u.action==='localClearBin'){
    var all=wbStore(); all[u.payload.name]={samples:u.payload.samples}; wbSave(all); wbRender(); toast('Bin restored');
  } else { toast('Undo not supported for last action'); }
}

// UI binds
if(document.getElementById('backBtn')) document.getElementById('backBtn').addEventListener('click', doUndo);

if(document.getElementById('wbAddSample')) wbAddSample.onclick=function(){
  var bu=currentBushels(); if(!(bu>0)) { alert('Enter bushels or pick a fraction'); return; }
  if(!window._lastCalc){ alert('Calculate first'); return; }
  var all=wbStore(), b=all[wbSelect.value]||{samples:[]};
  var entry={id:crypto.randomUUID(), ts:new Date().toISOString(), moisture:_lastCalc.corrected, bu:bu, crop:crop.value, source:'calc'};
  b.samples.push(entry); all[wbSelect.value]=b; wbSave(all); wbRender();
  pushUndo('localDeleteEntry', {entry:entry}); // allow undo add
  maybeAutoPush(bu, _lastCalc.corrected);
};

function delEntry(id){
  var all=wbStore(), b=all[wbSelect.value]; if(!b) return;
  var idx=b.samples.findIndex(x=>x.id===id); if(idx<0) return;
  var entry=b.samples[idx];
  if(!confirm('Delete this log?')) return;
  b.samples.splice(idx,1); all[wbSelect.value]=b; wbSave(all); wbRender();
  pushUndo('localDeleteEntry', {entry:entry}); // pressing undo will re-add entry
}

// local clear
if(document.getElementById('wbClear')) wbClear.onclick=function(){
  if(!confirm('Clear all entries in '+wbSelect.value+' (local)?')) return;
  var all=wbStore(); var snap=(all[wbSelect.value]?.samples||[]).slice();
  pushUndo('localClearBin', {name:wbSelect.value, samples:snap});
  all[wbSelect.value]={samples:[]}; wbSave(all); wbRender();
};

// ---- Team Sync (Owner, includes instant local Empty on dashboard)
function cfg(){ return jget('syncSettings', {on:true,farmId:'Rogers Sask',device:'',url:'https://script.google.com/macros/s/AKfycbxLMIUamQ6cITBx7kfwGw0z_Bs4CKH96_Y9_0GkpqyAAIWQxlhgS4NU2RFivxg77Ip9ig/exec',secret:'',auto:true}) }
function saveCfg(c){ jset('syncSettings', c) }
function syncOn(){ return cfg().on && cfg().url && cfg().farmId }
function setCfgFromUI(){
  saveCfg({ on:(syncEnable.value==='on'), farmId:farmId.value.trim(), device:deviceName.value.trim(), url:endpoint.value.trim(), secret:secret.value.trim(), auto:(autoPush.value==='on') });
}
['syncEnable','farmId','deviceName','endpoint','secret','autoPush'].forEach(id=>{ var el=document.getElementById(id); if(el) el.addEventListener('change', setCfgFromUI); });
function loadCfgIntoUI(){ var c=cfg(); syncEnable.value = c.on?'on':'off'; farmId.value=c.farmId; endpoint.value=c.url; secret.value=c.secret; autoPush.value=c.auto?'on':'off'; }

async function push(payload){
  var c=cfg(); if(!c.on || !c.url || !c.farmId) return null;
  try{ var r=await fetch(c.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(payload)}); return await r.json(); }
  catch(e){ return null; }
}
function maybeAutoPush(bu,moist){
  var c=cfg(); if(!(c.auto && c.on)) return;
  var payload={action:'addSample', farmId:c.farmId, secret:c.secret, device:c.device||'Owner', bin:wbSelect.value||'Wet Bin 1',
               sample:{meter:meter.value,crop:crop.value,read:reading.value,tempC:(tempUnit.value==='F'?((parseFloat(tempVal.value)-32)*5/9):parseFloat(tempVal.value)),corrected:(moist||0),bushels:(bu||0),grams:grams.value||''}};
  push(payload);
}

async function pullDashboard(){
  var c=cfg(); if(!c.on) return;
  try{
    var resp=await fetch(c.url+'?action=getBins&farmId='+encodeURIComponent(c.farmId)+'&secret='+(c.secret||''));
    var js=await resp.json(); var bins=js.bins||{};
    var html='<div class=grid>';
    Object.keys(bins).forEach(function(name){
      var b=bins[name];
      html+='<div class=bin-card>'
          + '<div class=bin-title>'+name+'</div>'
          + '<div class=bin-meta>Avg: <b class=mono>'+Number(b.avg||0).toFixed(1)+'%</b><br>Total: <span class=mono>'+(b.total||0)+'</span> bu</div>'
          + '<div class=bin-actions>'
          +   '<button class="btn sm" data-act=empty data-bin="'+name+'">Empty</button>'
          +   '<button class="btn sm gray" data-act=refresh data-bin="'+name+'">Refresh</button>'
          + '</div></div>';
    });
    html+='</div>'; teamDash.innerHTML=html;
    Array.from(teamDash.querySelectorAll('button[data-act]')).forEach(btn=>btn.onclick=()=>dashAction(btn));
    document.getElementById('syncStatus').textContent='Pulled ✓';
  }catch(e){ document.getElementById('syncStatus').textContent='Pull failed'; }
}

async function dashAction(btn){
  var act=btn.getAttribute('data-act'), name=btn.getAttribute('data-bin'); if(!act||!name) return;
  if(act==='refresh'){ pullDashboard(); return; }
  if(act==='empty'){
    if(!confirm('Empty "'+name+'"? This also clears local copy.')) return;
    // Take local snapshot for undo
    var all=wbStore(); var snap=(all[name]?.samples||[]).slice();
    pushUndo('localReplaceBin', {name:name, samples:snap});
    // Local instant clear
    all[name]={samples:[]}; wbSave(all); if(wbSelect && wbSelect.value===name) wbRender();
    // Push to server
    var js = await push({action:'emptyBin', farmId:cfg().farmId, secret:cfg().secret, bin:name});
    toast(js && js.ok ? 'Emptied '+name : 'Empty failed on server');
    pullDashboard();
  }
}

// init
window.addEventListener('DOMContentLoaded', ()=>{
  applyGramsDefault(); ensureDefaultBin(); 
  // bins dropdown
  var s=wbStore(); wbSelect.innerHTML=''; Object.keys(s).forEach(n=>{ var o=document.createElement('option'); o.value=n; o.textContent=n; wbSelect.appendChild(o); });
  document.getElementById('wbName').textContent = wbSelect.value || '—';
  wbRender(); loadCfgIntoUI();
  // buttons
  if(document.getElementById('pullNow')) pullNow.onclick=pullDashboard;
  if(document.getElementById('pushNow')) pushNow.onclick=function(){ if(!_lastCalc){toast('Calculate first');return;} maybeAutoPush(0,_lastCalc.corrected); toast('Pushed'); };
});
</script>

</body></html>